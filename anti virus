"""
×˜×•×‘ ××– ×œ×§×•×“ ×”×–×” ×™×© ×©×œ×•×© ×¤×•× ×§×¦×™×•×ª: ×©×œ×™×—×ª ×”×§×•×‘×¥, ×§×¨×™××ª ×”×¡×¨×™×§×” ×•×ª×¦×•×’×”.
 ××ª ×¤×•× ×§×¦×™×™×ª ×”×ª×¦×•×’×” ×•×”××™×™×Ÿ ×¢×©×™×ª×™ ×¢× ×§×œ×•×“ ×•×‘×™×§×©×ª×™ ××× ×• ×œ×©×™× ×”×¢×¨×•×ª ×œ××•×¨×š ×›×œ ×”×§×•×“.

"""


import requests
import time
import os

# ========== Configuration ==========
# API_KEY and FILE_PATH will be requested from user at runtime

# ========== Functions ==========

def upload_file(file_path, api_key):
    """
    Upload a file to VirusTotal for scanning
    """
    # Check if file exists
    if not os.path.exists(file_path):
        print(f"âŒ Error: File not found: {file_path}")
        return None
    
    # Get file size
    file_size = os.path.getsize(file_path)
    print(f"ğŸ“„ File: {os.path.basename(file_path)}")
    print(f"ğŸ“Š Size: {file_size / 1024:.2f} KB")
    
    # Check size limit (32MB for free accounts)
    if file_size > 32 * 1024 * 1024:
        print("âš ï¸ File too large (over 32MB). Free accounts limited to 32MB.")
        return None
    
    # Upload URL
    url = "https://www.virustotal.com/api/v3/files"
    
    # Headers with API key
    headers = {
        "x-apikey": api_key
    }
    
    print("\nğŸ“¤ Uploading file to VirusTotal...")
    
    try:
        # Open and upload file
        with open(file_path, 'rb') as f:
            files = {"file": (os.path.basename(file_path), f)}
            response = requests.post(url, headers=headers, files=files)
        
        # Check response
        if response.status_code == 200:
            data = response.json()
            print("âœ… Upload successful!")
            return data
        else:
            print(f"âŒ Upload failed with status code: {response.status_code}")
            print(f"Response: {response.text}")
            return None
            
    except Exception as e:
        print(f"âŒ Error: {e}")
        return None


def get_analysis_report(analysis_id, api_key):
    """
    Get the scan report using analysis ID
    """
    url = f"https://www.virustotal.com/api/v3/analyses/{analysis_id}"
    
    headers = {
        "x-apikey": api_key
    }
    
    try:
        response = requests.get(url, headers=headers)
        
        if response.status_code == 200:
            return response.json()
        else:
            print(f"âŒ Error getting report: {response.status_code}")
            return None
            
    except Exception as e:
        print(f"âŒ Error: {e}")
        return None


def display_results(report_data):
    """
    Display scan results in a readable format
    """
    if not report_data or "data" not in report_data:
        print("âŒ No valid report data")
        return
    
    attrs = report_data["data"]["attributes"]
    stats = attrs.get("stats", {})
    
    print("\n" + "="*60)
    print("ğŸ“Š SCAN RESULTS")
    print("="*60)
    
    # Status
    status = attrs.get("status", "unknown")
    print(f"Status: {status}")
    
    # Statistics
    malicious = stats.get("malicious", 0)
    suspicious = stats.get("suspicious", 0)
    undetected = stats.get("undetected", 0)
    harmless = stats.get("harmless", 0)
    total = sum(stats.values())
    
    print(f"\nğŸ” Detection Results:")
    print(f"   Malicious:   {malicious}")
    print(f"   Suspicious:  {suspicious}")
    print(f"   Undetected:  {undetected}")
    print(f"   Harmless:    {harmless}")
    print(f"   Total scans: {total}")
    
    # Final verdict
    print(f"\nğŸ¯ Final Verdict:")
    if malicious == 0 and suspicious == 0:
        print("   âœ… File appears to be CLEAN")
    elif malicious <= 3:
        print(f"   âš ï¸ File is SUSPICIOUS ({malicious} detections)")
        print("   This could be a false positive")
    else:
        print(f"   âŒ File is likely INFECTED ({malicious} detections)")
        print("   Recommended action: DELETE this file")
    
    print("="*60)


# ========== Main Program ==========

def main():
    """
    Main function to upload and scan file
    """
    print("="*60)
    print("ğŸ›¡ï¸  VirusTotal File Scanner")
    print("="*60)
    
    # Get API key from user
    print("\nğŸ”‘ API Key Setup")
    print("   Get your free API key from: https://www.virustotal.com")
    api_key = input("\nEnter your VirusTotal API Key: ").strip()
    
    if not api_key:
        print("âŒ API key is required. Exiting.")
        return
    
    # Get file path from user
    print("\nğŸ“ File Selection")
    print("   Enter the full path to the file you want to scan")
    print("   Example: C:\\Users\\YourName\\Downloads\\file.exe")
    file_path = input("\nEnter file path: ").strip()
    
    # Remove quotes if user copied path with quotes
    file_path = file_path.strip('"').strip("'")
    
    if not file_path:
        print("âŒ File path is required. Exiting.")
        return
    
    print("\n" + "="*60)
    
    # Step 1: Upload file
    upload_result = upload_file(file_path, api_key)
    
    if not upload_result:
        print("\nâŒ Upload failed. Exiting.")
        return
    
    # Get analysis ID
    analysis_id = upload_result["data"]["id"]
    print(f"ğŸ“‹ Analysis ID: {analysis_id}")
    
    # Step 2: Wait for scan to complete
    print("\nâ³ Waiting for scan to complete...")
    print("   (This usually takes 10-30 seconds)")
    
    max_attempts = 10
    for attempt in range(1, max_attempts + 1):
        print(f"\nğŸ”„ Check attempt {attempt}/{max_attempts}")
        
        time.sleep(10)  # Wait 10 seconds between checks
        
        report = get_analysis_report(analysis_id, api_key)
        
        if report:
            status = report["data"]["attributes"].get("status")
            
            if status == "completed":
                print("âœ… Scan completed!")
                display_results(report)
                return
            else:
                print(f"   Status: {status} - still scanning...")
    
    print("\nâš ï¸ Scan is taking longer than expected.")
    print(f"   You can check results later with analysis ID: {analysis_id}")


# ========== Run Program ==========
if __name__ == "__main__":
    main()